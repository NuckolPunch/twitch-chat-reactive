<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chat Reactive</title>
<style>
  body {
    margin: 0;
    background: transparent;
    overflow: hidden;
  }
  #avatar {
    width: 100%;
    height: 100%;
  }
</style>
</head>
<body>
<img id="avatar" src="" alt="avatar">

<script src="https://cdn.jsdelivr.net/npm/tmi.js@1.8.5"></script>
<script>
  // --- Get query parameters ---
  const urlParams = new URLSearchParams(window.location.search);
  const channelName = urlParams.get('channel');
  const idleImg = urlParams.get('idle');
  const talkingImg = urlParams.get('reacting');
  const duration = parseInt(urlParams.get('duration') || '1500', 10);

  const avatar = document.getElementById('avatar');
  avatar.src = idleImg;

  let revertTimeout;

  function startConnection() {
    console.log("Connecting to Twitch chat...");

    const client = new tmi.Client({
      channels: [channelName]
    });

    client.connect().catch(err => {
      console.error("Connection error:", err);
      retryConnection();
    });

    client.on('message', () => {
      avatar.src = talkingImg;
      clearTimeout(revertTimeout);
      revertTimeout = setTimeout(() => {
        avatar.src = idleImg;
      }, duration);
    });

    client.on('disconnected', () => {
      console.warn("Disconnected from Twitch chat. Retrying in 5s...");
      retryConnection();
    });

    function retryConnection() {
      setTimeout(() => {
        startConnection();
      }, 5000);
    }
  }

  startConnection();
</script>
</body>
</html>
