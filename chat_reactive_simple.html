<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Chat Reactive Simple</title>
<style>
  body {
    margin: 0;
    background: transparent;
    overflow: hidden;
  }
  #avatar {
    width: 100%;
    height: 100%;
  }
</style>
</head>
<body>
<img id="avatar" src="" alt="avatar" />

<script src="https://cdn.jsdelivr.net/npm/tmi.js@1.8.5"></script>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const channelName = urlParams.get('channel');
  const idleImg = urlParams.get('idle');
  const talkingImgs = (urlParams.get('reacting') || '').split(',').filter(Boolean);

  const duration = parseInt(urlParams.get('duration') || '1500', 10);
  const animationSpeed = parseInt(urlParams.get('speed') || '150', 10);
  const randomMode = urlParams.get('random') === 'true';

  const avatar = document.getElementById('avatar');
  avatar.src = idleImg;

  let revertTimeout;
  let animationInterval;
  let talking = false;

  function playAnimation(frames) {
    clearInterval(animationInterval);
    if (frames.length === 0) {
      avatar.src = idleImg;
      return;
    }
    if (frames.length === 1) {
      avatar.src = frames[0];
      return;
    }
    if (randomMode) {
      animationInterval = setInterval(() => {
        const idx = Math.floor(Math.random() * frames.length);
        avatar.src = frames[idx];
      }, animationSpeed);
    } else {
      let frame = 0;
      animationInterval = setInterval(() => {
        avatar.src = frames[frame % frames.length];
        frame++;
      }, animationSpeed);
    }
  }

  function startTalking() {
    if (!talking) talking = true;
    clearTimeout(revertTimeout);

    playAnimation(talkingImgs);

    revertTimeout = setTimeout(() => {
      stopTalking();
    }, duration);
  }

  function stopTalking() {
    talking = false;
    clearInterval(animationInterval);
    avatar.src = idleImg;
  }

  function startConnection() {
    const client = new tmi.Client({ channels: [channelName] });
    client.connect().catch(() => setTimeout(startConnection, 5000));

    client.on('message', (_, __, message, self) => {
      if (self) return;
      startTalking();
    });

    client.on('disconnected', () => {
      setTimeout(startConnection, 5000);
    });
  }

  startConnection();
</script>
</body>
</html>