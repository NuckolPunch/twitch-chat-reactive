<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Chat Reactive</title>
<style>
  body {
    margin: 0;
    background: transparent;
    overflow: hidden;
  }
  #avatar {
    width: 100%;
    height: 100%;
  }
</style>
</head>
<body>
<img id="avatar" src="" alt="avatar" />

<script src="https://cdn.jsdelivr.net/npm/tmi.js@1.8.5"></script>
<script>
  // --- URL params ---
  const urlParams = new URLSearchParams(window.location.search);
  const channelName = urlParams.get('channel');
  const idleImg = urlParams.get('idle');

  // Arrays of frame URLs for each reaction type
  const talkingImgs = (urlParams.get('reacting') || '').split(',').filter(Boolean);
  const questionImgs = (urlParams.get('question') || '').split(',').filter(Boolean);
  const exclaimImgs = (urlParams.get('exclaim') || '').split(',').filter(Boolean);

  const duration = parseInt(urlParams.get('duration') || '1500', 10);
  const animationSpeed = parseInt(urlParams.get('speed') || '150', 10);
  const randomMode = urlParams.get('random') === 'true';
  const talkDelay = parseInt(urlParams.get('talkdelay') || duration, 10);

  const avatar = document.getElementById('avatar');
  avatar.src = idleImg;

  let revertTimeout;
  let animationInterval;
  let talking = false;

  // Helper: play animation from an array of images
  function playAnimation(frames) {
    clearInterval(animationInterval);
    if (frames.length === 0) {
      avatar.src = idleImg;
      return;
    }
    if (frames.length === 1) {
      avatar.src = frames[0];
      return;
    }

    if (randomMode) {
      animationInterval = setInterval(() => {
        const randomIndex = Math.floor(Math.random() * frames.length);
        avatar.src = frames[randomIndex];
      }, animationSpeed);
    } else {
      let frame = 0;
      animationInterval = setInterval(() => {
        avatar.src = frames[frame % frames.length];
        frame++;
      }, animationSpeed);
    }
  }

  function startTalkingAnimation(msg) {
    if (!talking) {
      talking = true;
    }
    clearTimeout(revertTimeout);

    // Determine which frame set to use based on message end
    let framesToUse = talkingImgs;
    if (msg.endsWith('?') && questionImgs.length) {
      framesToUse = questionImgs;
    } else if (msg.endsWith('!') && exclaimImgs.length) {
      framesToUse = exclaimImgs;
    }

    playAnimation(framesToUse);

    revertTimeout = setTimeout(() => {
      stopTalkingAnimation();
    }, talkDelay);
  }

  function stopTalkingAnimation() {
    talking = false;
    clearInterval(animationInterval);
    avatar.src = idleImg;
  }

  function startConnection() {
    console.log('Connecting to Twitch chat...');
    const client = new tmi.Client({
      channels: [channelName]
    });

    client.connect().catch(err => {
      console.error('Connection error:', err);
      retryConnection();
    });

    client.on('message', (channel, tags, message, self) => {
      if (self) return; // ignore own messages
      startTalkingAnimation(message.trim());
    });

    client.on('disconnected', () => {
      console.warn('Disconnected from Twitch chat. Retrying in 5s...');
      retryConnection();
    });

    function retryConnection() {
      setTimeout(() => {
        startConnection();
      }, 5000);
    }
  }

  startConnection();
</script>
</body>
</html>
